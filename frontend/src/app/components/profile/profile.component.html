<div class="container">
  <!-- Navigation Tabs -->
  <div class="dashboard-tabs">
    <a routerLink="/home" class="dashboard-tab">
      <span>{{ 'nav.matches' | translate }}</span>
    </a>
    <a routerLink="/groups" class="dashboard-tab">
      <span>{{ 'nav.groups' | translate }}</span>
    </a>
    <a routerLink="/profile" class="dashboard-tab profile-tab active">
      <img *ngIf="currentUser?.profilePicture"
           [src]="currentUser!.profilePicture!"
           alt="Profile"
           class="tab-profile-picture">
      <span *ngIf="!currentUser?.profilePicture" class="tab-profile-placeholder">
        {{ currentUser?.username?.charAt(0)?.toUpperCase() }}
      </span>
      <span class="profile-tab-name">{{ currentUser?.username }}</span>
    </a>
  </div>

  <div class="profile-card">
    <h1>{{ 'profile.title' | translate }}</h1>

    <!-- Profile Picture Section -->
    <div class="profile-picture-section">
      <div class="profile-picture-container">
        <img
          *ngIf="currentUser?.profilePicture"
          [src]="getProfilePictureUrl(currentUser?.profilePicture || '')"
          alt="Profile"
          class="profile-picture"
          (error)="onImageError($event)"
        />
        <div *ngIf="!currentUser?.profilePicture" class="profile-picture-placeholder">
          {{ getInitial() }}
        </div>
      </div>
      <div class="profile-picture-actions">
        <label class="btn-upload">
          <input
            type="file"
            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
            (change)="onFileSelected($event)"
            hidden
          />
          {{ 'profile.uploadPicture' | translate }}
        </label>
        <button
          *ngIf="currentUser?.profilePicture"
          (click)="deleteProfilePicture()"
          class="btn-remove-picture"
          [disabled]="loadingPicture"
        >
          {{ 'profile.removePicture' | translate }}
        </button>
      </div>
    </div>

    <!-- Profile Info Section -->
    <div class="section">
      <h2>{{ 'profile.accountInfo' | translate }}</h2>
      <form (ngSubmit)="updateProfile()">
        <div class="form-group">
          <label>{{ 'auth.username' | translate }}</label>
          <input
            type="text"
            [(ngModel)]="profileData.username"
            name="username"
            class="form-control"
            [placeholder]="'auth.username' | translate"
            minlength="3"
            maxlength="30"
          />
        </div>
        <div class="form-group">
          <label>{{ 'auth.email' | translate }}</label>
          <input
            type="email"
            [(ngModel)]="profileData.email"
            name="email"
            class="form-control"
            [placeholder]="'auth.email' | translate"
          />
        </div>
        <button type="submit" [disabled]="loadingProfile" class="btn-primary">
          {{ loadingProfile ? ('auth.loading' | translate) : ('common.save' | translate) }}
        </button>
      </form>
    </div>

    <!-- Change Password Section - Only show for users with password -->
    <div class="section" *ngIf="hasPassword">
      <h2>{{ 'profile.changePassword' | translate }}</h2>
      <form (ngSubmit)="changePassword()">
        <div class="form-group">
          <label>{{ 'profile.currentPassword' | translate }}</label>
          <input
            type="password"
            [(ngModel)]="passwordData.currentPassword"
            name="currentPassword"
            class="form-control"
            [placeholder]="'profile.currentPassword' | translate"
          />
        </div>
        <div class="form-group">
          <label>{{ 'profile.newPassword' | translate }}</label>
          <input
            type="password"
            [(ngModel)]="passwordData.newPassword"
            name="newPassword"
            class="form-control"
            [placeholder]="'profile.newPassword' | translate"
            minlength="6"
          />
        </div>
        <div class="form-group">
          <label>{{ 'profile.confirmPassword' | translate }}</label>
          <input
            type="password"
            [(ngModel)]="passwordData.confirmPassword"
            name="confirmPassword"
            class="form-control"
            [placeholder]="'profile.confirmPassword' | translate"
          />
        </div>
        <button type="submit" [disabled]="loadingPassword" class="btn-primary">
          {{ loadingPassword ? ('auth.loading' | translate) : ('profile.changePassword' | translate) }}
        </button>
      </form>
    </div>

    <!-- Settings Section -->
    <div class="section">
      <h2>{{ 'profile.settings' | translate }}</h2>

      <div class="setting-group">
        <label>{{ 'profile.language' | translate }}</label>
        <app-select
          [options]="languageOptions"
          [(ngModel)]="settingsData.language"
          (ngModelChange)="onSettingChange()"
          placeholder="Select language"
          placeholderHe="בחר שפה">
        </app-select>
      </div>

      <div class="setting-group">
        <label>{{ 'profile.theme' | translate }}</label>
        <app-select
          [options]="themeOptions"
          [(ngModel)]="settingsData.theme"
          (ngModelChange)="onSettingChange()"
          placeholder="Select theme"
          placeholderHe="בחר ערכת נושא">
        </app-select>
      </div>

      <div class="setting-group toggle-group">
        <label>{{ 'profile.autoBet' | translate }}</label>
        <p class="setting-description">{{ 'profile.autoBetDescription' | translate }}</p>
        <app-toggle
          [(ngModel)]="settingsData.autoBet"
          (ngModelChange)="onSettingChange()">
        </app-toggle>
      </div>

      <button
        (click)="saveSettings()"
        [disabled]="loadingSettings || !settingsChanged"
        class="btn-primary"
      >
        {{ loadingSettings ? ('auth.loading' | translate) : ('common.save' | translate) }}
      </button>
    </div>

    <!-- Telegram Reminders Section -->
    <div class="section telegram-section">
      <h2>{{ 'profile.telegramReminders' | translate }}</h2>
      <p class="setting-description">{{ 'profile.telegramDescription' | translate }}</p>

      <!-- Not Linked State -->
      <div *ngIf="!telegramSettings?.isLinked" class="telegram-not-linked">
        <div *ngIf="!linkCode" class="link-instructions">
          <p>{{ 'profile.telegramInstructions' | translate }}</p>
          <button
            (click)="generateTelegramLinkCode()"
            [disabled]="loadingTelegram"
            class="btn-primary"
          >
            {{ loadingTelegram ? ('auth.loading' | translate) : ('profile.generateLinkCode' | translate) }}
          </button>
        </div>

        <div *ngIf="linkCode" class="link-code-display">
          <p>{{ 'profile.sendCodeToBot' | translate }}</p>
          <div class="code-box">
            <code>/start {{ linkCode }}</code>
            <button (click)="copyCode()" class="btn-copy" [title]="'common.copy' | translate">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
          <a
            [href]="'https://t.me/' + botUsername + '?start=' + linkCode"
            target="_blank"
            class="btn-telegram"
          >
            {{ 'profile.openTelegram' | translate }}
          </a>
          <p class="code-expiry">{{ 'profile.codeExpires' | translate }}: {{ codeExpiresAt | date:'short' }}</p>
        </div>
      </div>

      <!-- Linked State -->
      <div *ngIf="telegramSettings?.isLinked" class="telegram-linked">
        <div class="linked-status">
          <span class="status-badge connected">{{ 'profile.telegramConnected' | translate }}</span>
          <span class="linked-date">{{ 'profile.linkedOn' | translate }}: {{ telegramSettings?.linkedAt | date:'mediumDate' }}</span>
        </div>

        <div class="setting-group toggle-group">
          <label>{{ 'profile.enableReminders' | translate }}</label>
          <app-toggle
            [(ngModel)]="telegramSettings!.reminderEnabled"
            (ngModelChange)="onTelegramSettingChange()">
          </app-toggle>
        </div>

        <div class="setting-group" *ngIf="telegramSettings?.reminderEnabled">
          <label>{{ 'profile.reminderTiming' | translate }}</label>
          <app-select
            [options]="reminderSelectOptions"
            [(ngModel)]="telegramSettings!.reminderMinutes"
            (ngModelChange)="onTelegramSettingChange()"
            placeholder="Select reminder time"
            placeholderHe="בחר זמן תזכורת">
          </app-select>
        </div>

        <div class="telegram-actions">
          <button
            *ngIf="telegramSettingsChanged"
            (click)="saveTelegramSettings()"
            [disabled]="loadingTelegram"
            class="btn-primary"
          >
            {{ loadingTelegram ? ('auth.loading' | translate) : ('common.save' | translate) }}
          </button>
          <button
            (click)="unlinkTelegram()"
            [disabled]="loadingTelegram"
            class="btn-unlink"
          >
            {{ 'profile.unlinkTelegram' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Account Section -->
    <div class="section danger-section">
      <h2>{{ 'profile.deleteAccount' | translate }}</h2>
      <p class="warning-text">{{ 'profile.deleteWarning' | translate }}</p>

      <button
        *ngIf="!showDeleteConfirm"
        (click)="showDeleteConfirm = true"
        class="btn-danger"
      >
        {{ 'profile.deleteAccount' | translate }}
      </button>

      <div *ngIf="showDeleteConfirm" class="delete-confirm">
        <p>{{ (hasPassword ? 'profile.confirmDeleteMessage' : 'profile.confirmDeleteOAuth') | translate }}</p>
        <div class="form-group" *ngIf="hasPassword">
          <label>{{ 'profile.enterPassword' | translate }}</label>
          <input
            type="password"
            [(ngModel)]="deletePassword"
            class="form-control"
            [placeholder]="'auth.password' | translate"
          />
        </div>
        <div class="button-row">
          <button
            (click)="deleteAccount()"
            [disabled]="loadingDelete || (hasPassword && !deletePassword)"
            class="btn-danger"
          >
            {{ loadingDelete ? ('auth.loading' | translate) : ('profile.confirmDelete' | translate) }}
          </button>
          <button (click)="cancelDelete()" class="btn-secondary">
            {{ 'groups.cancel' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
